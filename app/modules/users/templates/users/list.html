{% extends "base.html" %}
{% block body %}

<style>
    /* Enhanced Users List Styles */
    .users-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, #00A3AD 0%, #008A93 100%);
        border-radius: 1rem;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 163, 173, 0.2);
    }
    
    .page-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .page-title {
        color: white;
        font-size: 2rem;
        font-weight: 800;
        margin: 0;
    }
    
    .page-subtitle {
        color: rgba(255, 255, 255, 0.9);
        margin-top: 0.5rem;
    }
    
    .header-actions {
        display: flex;
        gap: 1rem;
    }
    
    .btn-header {
        padding: 0.75rem 1.5rem;
        background: white;
        color: #00A3AD;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-header:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* Search and Filters */
    .filters-section {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .search-bar {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .search-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #00A3AD;
    }
    
    .btn-search {
        padding: 0.75rem 2rem;
        background: linear-gradient(135deg, #00A3AD 0%, #008A93 100%);
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 163, 173, 0.3);
    }
    
    .filter-toggle {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Users Grid */
    .users-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    /* User Card */
    .user-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .user-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .user-card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #00A3AD 0%, #008A93 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 800;
        flex-shrink: 0;
    }
    
    .user-info {
        flex: 1;
    }
    
    .user-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }
    
    .user-details {
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .user-email {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    
    /* Permission Level Badge */
    .permission-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    
    .permission-badge.s1 {
        background: linear-gradient(135deg, #dc2626, #991b1b);
        color: white;
    }
    
    .permission-badge.l3 {
        background: linear-gradient(135deg, #7c3aed, #5b21b6);
        color: white;
    }
    
    .permission-badge.l2 {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
    }
    
    .permission-badge.l1 {
        background: linear-gradient(135deg, #0891b2, #0e7490);
        color: white;
    }
    
    .permission-badge.module {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }
    
    /* Permissions Section */
    .user-permissions {
        border-top: 1px solid #e5e7eb;
        padding-top: 1rem;
        margin-top: 1rem;
    }
    
    .permissions-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 0.5rem;
    }
    
    .permissions-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .perm-tag {
        padding: 0.25rem 0.5rem;
        background: #f3f4f6;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        color: #4b5563;
        border: 1px solid #e5e7eb;
    }
    
    .perm-tag.admin {
        background: #fef3c7;
        color: #92400e;
        border-color: #fcd34d;
    }
    
    /* User Actions */
    .user-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .btn-user-action {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        text-decoration: none;
        color: #4b5563;
    }
    
    .btn-user-action:hover {
        background: #f9fafb;
        border-color: #00A3AD;
        color: #00A3AD;
    }
    
    .btn-user-action.delete {
        color: #dc2626;
        border-color: #fca5a5;
    }
    
    .btn-user-action.delete:hover {
        background: #fef2f2;
        border-color: #dc2626;
    }
    
    /* Status Indicators */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-indicator.active {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-indicator.inactive {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-indicator.pending-deletion {
        background: #fef3c7;
        color: #92400e;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .empty-state-icon {
        font-size: 4rem;
        color: #d1d5db;
        margin-bottom: 1rem;
    }
    
    .empty-state-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }
    
    .empty-state-text {
        color: #6b7280;
        margin-bottom: 2rem;
    }
</style>

<div class="users-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div>
                <h1 class="page-title">Users Management</h1>
                <p class="page-subtitle">Manage user accounts and permissions</p>
            </div>
            <div class="header-actions">
                {% if can_create %}
                <a href="{{ url_for('users.create') }}" class="btn-header">
                    <i class="bi bi-person-plus"></i>
                    Add User
                </a>
                {% endif %}
                {% if cu.permission_level in ['L1', 'L2', 'L3', 'S1'] %}
                <a href="{{ url_for('users.elevation_management') }}" class="btn-header">
                    <i class="bi bi-shield-check"></i>
                    Elevation Management
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Search and Filters -->
    <div class="filters-section">
        <form method="get" class="search-bar">
            <input type="text" 
                   name="q" 
                   class="search-input" 
                   placeholder="Search by username, name, email, or department..." 
                   value="{{ q }}">
            <button type="submit" class="btn-search">
                <i class="bi bi-search"></i>
                Search
            </button>
            <div class="filter-toggle">
                <input type="checkbox" 
                       id="show-all" 
                       name="all" 
                       value="1" 
                       {% if show_all %}checked{% endif %}>
                <label for="show-all">Show inactive users</label>
            </div>
        </form>
    </div>
    
    <!-- Users Grid -->
    {% if rows %}
    <div class="users-grid">
        {% for user in rows %}
        <div class="user-card">
            <!-- Permission Level Badge -->
            {% if user.permission_level %}
                {% if user.permission_level == 'S1' %}
                <span class="permission-badge s1">System</span>
                {% elif user.permission_level == 'L3' %}
                <span class="permission-badge l3">App Dev</span>
                {% elif user.permission_level == 'L2' %}
                <span class="permission-badge l2">Sys Admin</span>
                {% elif user.permission_level == 'L1' %}
                <span class="permission-badge l1">Module Admin</span>
                {% endif %}
            {% else %}
                <span class="permission-badge module">Module User</span>
            {% endif %}
            
            <div class="user-card-header">
                <div class="user-avatar">
                    {{ user.username[0]|upper }}
                </div>
                <div class="user-info">
                    <div class="user-name">{{ user.username }}</div>
                    <div class="user-details">
                        {% if user.first_name or user.last_name %}
                            {{ user.first_name }} {{ user.last_name }}
                        {% else %}
                            No name set
                        {% endif %}
                    </div>
                    {% if user.email %}
                    <div class="user-email">{{ user.email }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Status -->
            <div style="margin-bottom: 1rem;">
                {% if user.deleted_at %}
                <span class="status-indicator inactive">
                    <i class="bi bi-x-circle"></i>
                    Deleted
                </span>
                {% elif user.deletion_requested_at %}
                <span class="status-indicator pending-deletion">
                    <i class="bi bi-clock-history"></i>
                    Deletion Pending
                </span>
                {% else %}
                <span class="status-indicator active">
                    <i class="bi bi-check-circle"></i>
                    Active
                </span>
                {% endif %}
                
                {% if user.department %}
                <span style="margin-left: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                    {{ user.department }}
                </span>
                {% endif %}
            </div>
            
            <!-- Permissions -->
            <div class="user-permissions">
                <div class="permissions-title">
                    {% if user.permission_level %}
                    Administrative Access
                    {% else %}
                    Module Permissions
                    {% endif %}
                </div>
                <div class="permissions-list">
                    {% if user.permission_level %}
                        <span class="perm-tag admin">{{ user.permission_level_desc }}</span>
                    {% else %}
                        {% if user.effective_permissions.can_send %}
                        <span class="perm-tag">M1 - Send</span>
                        {% endif %}
                        {% if user.effective_permissions.can_inventory %}
                        <span class="perm-tag">M2 - Inventory</span>
                        {% endif %}
                        {% if user.effective_permissions.can_fulfillment_manager %}
                        <span class="perm-tag">M3C - Fulfillment Manager</span>
                        {% elif user.effective_permissions.can_fulfillment_service %}
                        <span class="perm-tag">M3B - Fulfillment Service</span>
                        {% elif user.effective_permissions.can_fulfillment_customer %}
                        <span class="perm-tag">M3A - Fulfillment Customer</span>
                        {% endif %}
                        
                        {% if not (user.effective_permissions.can_send or user.effective_permissions.can_inventory or user.effective_permissions.can_fulfillment_customer or user.effective_permissions.can_fulfillment_service or user.effective_permissions.can_fulfillment_manager) %}
                        <span class="perm-tag">No permissions assigned</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Actions -->
            <div class="user-actions">
                <a href="{{ url_for('users.edit_user', uid=user.id) }}" class="btn-user-action">
                    <i class="bi bi-pencil"></i>
                    Edit
                </a>
                {% if user.deletion_requested_at and cu.permission_level in ['L1', 'L2', 'L3', 'S1'] %}
                <a href="{{ url_for('users.deletion_requests') }}" class="btn-user-action">
                    <i class="bi bi-shield-exclamation"></i>
                    Review
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="bi bi-people"></i>
        </div>
        <div class="empty-state-title">No Users Found</div>
        <div class="empty-state-text">
            {% if q %}
            No users match your search criteria. Try adjusting your filters.
            {% else %}
            There are no users in the system yet. Create your first user to get started.
            {% endif %}
        </div>
        {% if can_create %}
        <a href="{{ url_for('users.create') }}" class="btn-header">
            <i class="bi bi-person-plus"></i>
            Add First User
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}