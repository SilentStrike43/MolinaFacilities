<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Molina Facilities</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root{
      --sidebar-width: 230px;
      --sidebar-collapsed: 64px;
      --molina-teal: {{ BRAND_TEAL }};
      --dark-bg:#2b2f33;
      --dark-surface:#363a3f;
      --dark-text:#e9ecef;
    }

    html, body { height:100%; }
    body { overflow-y:scroll; color:#212529; }   /* light mode readable text */
    a { color:#0d6efd; }

    /* Top bar (fixed height + compact brand logo) */
    .topbar{
      height:58px;
      display:flex; align-items:center; gap:12px;
      padding:0 16px; position:sticky; top:0; z-index:1020;
      background:var(--molina-teal); color:#fff;
      border-bottom:1px solid rgba(255,255,255,.15);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:600; }
    .brand img{ height:28px; width:auto; }
    .topbar img{ height:28px !important; width:auto !important; }
    .topbar .btn, .topbar .dropdown-toggle{ color:#fff; border-color:rgba(255,255,255,.55); }
    .topbar .btn:hover{ border-color:#fff; }

    /* Layout wrapper */
    .app-wrap{ display:flex; min-height:calc(100vh - 58px); }

    /* Sidebar */
    .sidebar{
      width:var(--sidebar-width);
      background:#e8f4f4;
      border-right:1px solid #d7e6e6;
      padding:12px 8px;
      position:sticky; top:58px;
      height:calc(100vh - 58px);
      overflow-y:auto;
      transition:width .2s ease;
    }
    .sidebar .section-title{
      font-size:.85rem; color:#2b6469; letter-spacing:.02em; margin:6px 10px 8px; text-transform:uppercase;
    }
    .nav-vertical .nav-link{
      display:flex; align-items:center; gap:10px;
      padding:.5rem .75rem; border-radius:.5rem; color:#134348;
      background:transparent !important; box-shadow:none !important;
    }
    .nav-vertical .nav-link:hover{ background:#d7eeee; }
    .nav-vertical .nav-link.active{ background:var(--molina-teal); color:#fff; }
    .sidebar .icon{ width:24px; text-align:center; }

    /* Collapsed state */
    .sidebar.collapsed{ width:var(--sidebar-collapsed); }
    .sidebar.collapsed .label, .sidebar.collapsed .section-title { display:none; }

    /* Main content */
    .content-wrap{ flex:1; padding:16px; }
    .flash-area{ margin-top:4px; }

    /* Badges */
    .badge-perm{padding:.35em .5em; border-radius:.5rem; font-weight:600; font-size:.7rem}
    .badge-fulfill{background:#0d6efd;}   /* Blue */
    .badge-insights{background:#198754;}  /* Green */
    .badge-send{background:#0a8e89;}      /* Teal */
    .badge-asset{background:#dc3545;}     /* Red */
    .badge-users{background:#6f42c1;}     /* Purple */
    .badge-admin{background:#000;}        /* Black */
    .badge-sysadmin{background:#6c757d;}  /* Grey */
    .badge-dev{background:#fd7e14;}       /* Orange */

    /* Dark mode */
    html[data-theme="dark"] body{ background:var(--dark-bg); color:var(--dark-text); }
    html[data-theme="dark"] a{ color:#8ecbff; }
    html[data-theme="dark"] .topbar{ background:var(--molina-teal); color:#fff; }
    html[data-theme="dark"] .sidebar{ background:#2e3338; border-right-color:#3a3f45; }
    html[data-theme="dark"] .nav-vertical .nav-link:hover{ background:#3a4248; }
    html[data-theme="dark"] .nav-vertical .nav-link.active{ background:#1f6d69; }
    html[data-theme="dark"] .card{ background:var(--dark-surface); color:var(--dark-text); }

    /* Version tag */
    .footer-version{ position:fixed; right:.75rem; bottom:.5rem; font-size:.75rem; opacity:.7; }

    /* Responsive */
    @media (max-width: 992px){
      .sidebar { width:var(--sidebar-collapsed); }
      .sidebar .label, .sidebar .section-title { display:none; }
    }
  </style>
</head>
<body>

  {% set cu = (g._cu if g and g._cu else None) %}
  {% set elevated = cu and (cu.is_admin or cu.is_sysadmin or cu.is_system) %}

  <!-- Top bar -->
  <div class="topbar">
    <button id="toggleSidebar" class="btn btn-sm btn-outline-light" aria-label="Toggle menu">
      <i class="bi bi-list"></i>
    </button>

    <div class="brand">
      <img src="{{ url_for('static', filename='img/Molina_Healthcare_logo.svg.png') }}" alt="Molina">
      <span>Molina Facilities</span>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <!-- Dark mode -->
      <button id="themeToggle" class="btn btn-sm btn-outline-light" type="button" title="Toggle dark mode">ðŸŒ“</button>

      <!-- Badges (one elevated tag; otherwise module tags) -->
      <div class="d-flex align-items-center gap-2">
        {% if cu %}
          {% if cu.is_system %}
            <span class="badge-perm badge-dev">App Developer</span>
          {% elif cu.is_sysadmin %}
            <span class="badge-perm badge-sysadmin">Systems Administrator</span>
          {% elif cu.is_admin %}
            <span class="badge-perm badge-admin">Administrator</span>
          {% else %}
            {% if cu.can_fulfillment_customer or cu.can_fulfillment_staff %}
              <span class="badge-perm badge-fulfill">Fulfillment</span>
            {% endif %}
            {% if cu.can_insights %}<span class="badge-perm badge-insights">Insights</span>{% endif %}
            {% if cu.can_send %}<span class="badge-perm badge-send">Send</span>{% endif %}
            {% if cu.can_asset %}<span class="badge-perm badge-asset">Asset</span>{% endif %}
            {% if cu.can_users %}<span class="badge-perm badge-users">Users</span>{% endif %}
          {% endif %}
        {% endif %}
      </div>

      <!-- Single username location (no duplicates) -->
      <div class="dropdown">
        <a class="btn btn-sm btn-outline-light dropdown-toggle" href="#" data-bs-toggle="dropdown">
          {{ cu.username if cu else 'Guest' }}
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
          {% if cu %}
            <li><a class="dropdown-item" href="{{ url_for('auth.change_password') }}">Change password</a></li>
            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
          {% else %}
            <li><a class="dropdown-item" href="{{ url_for('auth.login') }}">Login</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Below top bar -->
  <div class="app-wrap">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <!-- OPERATIONS -->
      <div class="section-title">Operations</div>
      <nav class="nav nav-vertical flex-column">
        <a class="nav-link {{ 'active' if active in ['send','send-tracking'] else '' }}" href="{{ url_for('mail.page') }}">
          <span class="icon"><i class="bi bi-send"></i></span> <span class="label">Send</span>
        </a>
        <a class="nav-link {{ 'active' if active=='send-tracking' else '' }}" href="{{ url_for('mail.tracking') }}">
          <span class="icon"><i class="bi bi-binoculars"></i></span> <span class="label">Tracking</span>
        </a>
      </nav>
    
      <!-- FULFILLMENT CENTER -->
      <div class="section-title mt-2">Fulfillment Center</div>
      <nav class="nav nav-vertical flex-column">
        {# Everyone can see the Request form link; access control still enforced in view #}
        <a class="nav-link {{ 'active' if active=='fulfillment' and page=='request' else '' }}"
           href="{{ url_for('fulfillment.request_form') }}">
          <span class="icon"><i class="bi bi-cloud-upload"></i></span> <span class="label">Request Fulfillment</span>
        </a>
    
        {# Staff OR elevated (Admin / SysAdmin / App Developer) see Queue/Archive #}
        {% set elevated = cu and (cu.is_admin or cu.is_sysadmin or cu.is_system) %}
        {% if cu and (cu.can_fulfillment_staff or elevated) %}
          <a class="nav-link {{ 'active' if active=='fulfillment' and page=='queue' else '' }}"
             href="{{ url_for('fulfillment.queue') }}">
            <span class="icon"><i class="bi bi-list-check"></i></span> <span class="label">Service Queue</span>
          </a>
          {# uncomment when route exists #}
          {# <a class="nav-link {{ 'active' if active=='fulfillment' and page=='archive' else '' }}"
             href="{{ url_for('fulfillment.archive') }}">
            <span class="icon"><i class="bi bi-archive"></i></span> <span class="label">Service Archive</span>
          </a> #}
        {% endif %}
      </nav>
    
      <!-- INVENTORY -->
      <div class="section-title mt-2">Inventory</div>
      <nav class="nav nav-vertical flex-column">
        <a class="nav-link {{ 'active' if active=='asset' else '' }}" href="{{ url_for('inventory.index') }}">
          <span class="icon"><i class="bi bi-box-seam"></i></span> <span class="label">Asset</span>
        </a>
      </nav>
    
      <!-- REPORTS -->
      <div class="section-title mt-2">Reports</div>
      <nav class="nav nav-vertical flex-column">
        <a class="nav-link {{ 'active' if active=='insights' and (tab=='mail') else '' }}" href="{{ url_for('reports.mail') }}">
          <span class="icon"><i class="bi bi-graph-up"></i></span> <span class="label">Insights (Mail)</span>
        </a>
        <a class="nav-link {{ 'active' if active=='insights' and (tab!='mail') else '' }}" href="{{ url_for('reports.inventory') }}">
          <span class="icon"><i class="bi bi-clipboard-data"></i></span> <span class="label">Insights (Inventory)</span>
        </a>
      </nav>
    
      <!-- PEOPLE -->
      <div class="section-title mt-2">People</div>
      <nav class="nav nav-vertical flex-column">
        <a class="nav-link {{ 'active' if active=='users' and tab=='list' else '' }}" href="{{ url_for('users.user_list') }}">
          <span class="icon"><i class="bi bi-people"></i></span> <span class="label">Users</span>
        </a>
        <a class="nav-link {{ 'active' if active=='users' and tab=='manage' else '' }}" href="{{ url_for('users.manage') }}">
          <span class="icon"><i class="bi bi-person-plus"></i></span> <span class="label">Modify Users</span>
        </a>
      </nav>
    
      <!-- ADMIN -->
      <div class="section-title mt-2">Admin</div>
      <nav class="nav nav-vertical flex-column">
        <a class="nav-link {{ 'active' if active=='admin' and page=='fields' else '' }}" href="{{ url_for('admin.modify_fields') }}">
          <span class="icon"><i class="bi bi-sliders"></i></span> <span class="label">Fields</span>
        </a>
        <a class="nav-link {{ 'active' if active=='admin' and page=='audit' else '' }}" href="{{ url_for('admin.audit') }}">
          <span class="icon"><i class="bi bi-journal-text"></i></span> <span class="label">Audit Logs</span>
        </a>
        {% if cu and (cu.is_sysadmin or cu.is_system) %}
          <a class="nav-link {{ 'active' if active=='admin' and page=='elevated' else '' }}"
             href="{{ url_for('admin.elevated') }}">
            <span class="icon"><i class="bi bi-shield-lock"></i></span> <span class="label">Elevated User Actions</span>
          </a>
        {% endif %}
      </nav>
    </aside>    

    <!-- Content -->
    <main class="content-wrap container-fluid">
      <div class="flash-area">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for cat, msg in messages %}
              <div class="alert alert-{{ cat if cat in ['success','danger','warning','info'] else 'info' }} py-2">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>
      {% block body %}{% endblock %}
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Sidebar toggle -->
  <script>
    (function(){
      const key = 'mf_sidebar_collapsed';
      const sidebar = document.getElementById('sidebar');
      function applyState(){
        const collapsed = localStorage.getItem(key) === '1';
        sidebar?.classList[collapsed ? 'add' : 'remove']('collapsed');
      }
      applyState();
      document.getElementById('toggleSidebar')?.addEventListener('click', () => {
        const next = !(localStorage.getItem(key) === '1');
        localStorage.setItem(key, next ? '1' : '0');
        applyState();
      });
    })();
  </script>

  <!-- Dark mode -->
  <script>
    (function(){
      const key="theme"; const html=document.documentElement;
      function apply(t){ t==="dark" ? html.setAttribute("data-theme","dark") : html.removeAttribute("data-theme"); }
      apply(localStorage.getItem(key)||"");
      document.getElementById("themeToggle")?.addEventListener("click", function(){
        const next = html.getAttribute("data-theme")==="dark" ? "" : "dark";
        apply(next); localStorage.setItem(key, next);
      });
    })();
  </script>

  <!-- Auto-dismiss flashes -->
  <script> setTimeout(()=>document.querySelectorAll('.alert').forEach(a=>a.remove()), 3500); </script>

  <!-- Version -->
  <div class="footer-version text-muted">v{{ APP_VERSION }}</div>
</body>
</html>
